# PRD: FMEA 워크시트 화면 v1.0

## 📋 문서 정보
| 항목 | 내용 |
|------|------|
| **버전** | v1.5.0 |
| **작성일** | 2025-12-28 |
| **상태** | In Progress (Phase 4 진행 - 고장분석 + SOD) |
| **참조** | PRD-005, FMEA_MASTER_PLAN.md |

---

## 1. 개요

### 1.1 목적
FMEA(Failure Mode and Effects Analysis) 분석을 단계별로 수행할 수 있는 워크시트 화면 개발

### 1.2 핵심 기능
- **좌측 워크시트**: 단계별 데이터 입력 (셀 병합 및 계층 트리 구조)
- **우측 트리/전체보기**: 계층 구조 시각화 + 40열 미리보기
- **기초정보 모달**: 표준 `BaseModal` 기반의 `DataSelectModal` 적용
- **실시간 동기화**: 입력 데이터가 전체 워크시트에 반영
- **트리 구조 행 생성**: 구분(Classification) -> 완제품기능 -> 요구사항의 논리적 계층 반영

---

## 2. 화면 구조

### 2.1 전체 레이아웃
```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 📱 상단바 (44px)                                                            │
│ [Level Views▼] [단계▼] | [고장연결] [Excel Export] | [저장상태]            │
├─────────────────────────────────────────────────────────────────────────────┤
│ 탭 메뉴                                                                     │
│ [구조분석] [기능분석] [고장분석] [고장연결] [리스크분석] [최적화] [📊전체]   │
│ [1 Level] [2 Level] [3 Level] [All Level]                                   │
├───────────────────────────────────┬─────────────────────────────────────────┤
│                                   │                                         │
│  📋 좌측: 워크시트 (60%)          │  🌳 우측: 트리/전체보기 (40%)           │
│                                   │                                         │
│  - 단계별 입력 테이블             │  [트리보기] [전체보기] 토글             │
│  - 셀 클릭 → 표준 데이터 선택 모달  │                                         │
│  - 부모/자식/손자: 트리형 병합     │  트리: 계층 구조 표시                   │
│  - 독립적 행 생성 로직 적용       │  전체: 40열 미니 워크시트               │
│                                   │                                         │
└───────────────────────────────────┴─────────────────────────────────────────┘
```

### 2.2 레이아웃 비율
| 영역 | 비율 | 설명 |
|------|------|------|
| 상단바 | 44px 고정 | 유틸리티 버튼 |
| 탭 메뉴 | 80px 고정 | 단계 선택 + 레벨 선택 |
| 좌측 워크시트 | 60% | 데이터 입력 영역 |
| 우측 패널 | 40% | 트리 또는 전체보기 |

---

## 3. 단계별 워크시트 정의

### 3.1 구조분석 (Structure Analysis)

#### Level 1 (2열)
| 열 | 컬럼명 | 데이터 소스 | 입력 방식 |
|----|--------|-------------|-----------|
| 1 | 완제품공정명 | 기초정보 | 🔍 모달 선택 |
| 2 | 완제품기능 | 직접입력 | ✏️ 텍스트 |

#### Level 2 (4열)
| 열 | 컬럼명 | 데이터 소스 | 입력 방식 | 병합 |
|----|--------|-------------|-----------|------|
| 1 | 완제품공정명 | 기초정보 | 🔍 모달 | rowspan |
| 2 | 메인공정 (NO+공정명) | 기초정보 | 🔍 모달 | rowspan |
| 3 | 4M | 선택 | ▼ 드롭다운 | - |
| 4 | 작업요소 | 직접입력 | ✏️ 텍스트 | - |

#### Level 3 (6열)
| 열 | 컬럼명 | 데이터 소스 | 입력 방식 | 병합 |
|----|--------|-------------|-----------|------|
| 1 | 완제품공정명 | 기초정보 | 🔍 모달 | rowspan |
| 2 | 메인공정 | 기초정보 | 🔍 모달 | rowspan |
| 3 | 4M | 선택 | ▼ 드롭다운 | rowspan |
| 4 | 작업요소 | 직접입력 | ✏️ 텍스트 | rowspan |
| 5 | 세부4M | 선택 | ▼ 드롭다운 | - |
| 6 | 세부요소 | 직접입력 | ✏️ 텍스트 | - |

### 3.2 기능분석 (Function Analysis)

#### Level 1 (6열)
| 열 | 컬럼명 | 병합 |
|----|--------|------|
| 1 | 완제품공정명 | rowspan |
| 2 | 구분 (Your Plant/Ship to/User) | rowspan |
| 3 | 완제품기능 | rowspan |
| 4 | 요구사항 | - |
| 5 | FE 구분 | - |
| 6 | 고장영향 (FE) | - |

#### Level 2 (10열)
| 열 | 컬럼명 | 병합 |
|----|--------|------|
| 1 | 완제품공정명 | rowspan |
| 2 | 메인공정 | rowspan |
| 3 | 구분 | rowspan |
| 4 | 공정기능 | rowspan |
| 5 | 공정요구사항 | - |
| 6 | FE 구분 | - |
| 7 | 고장영향 (FE) | - |
| 8 | 고장형태 (FM) | - |
| 9 | S (심각도) | - |
| 10 | 고장형태 SC | - |

#### Level 3 (14열)
| 열 | 컬럼명 | 병합 |
|----|--------|------|
| 1-4 | Level 2 동일 | rowspan |
| 5 | 4M | rowspan |
| 6 | 작업요소 | rowspan |
| 7 | 작업요소기능 | - |
| 8 | 작업요소요구 | - |
| 9-14 | FE, FM, FC 관련 | - |

### 3.3 고장분석 (Failure Analysis)

#### Level 3 (12열) - 핵심
| 열 | 컬럼명 | 설명 |
|----|--------|------|
| 1 | 완제품공정명 | rowspan |
| 2 | 메인공정 | rowspan |
| 3 | 4M | rowspan |
| 4 | 작업요소 | rowspan |
| 5 | 고장영향 (FE) | - |
| 6 | S (심각도) | 1-10 |
| 7 | 고장형태 (FM) | - |
| 8 | 고장형태 SC | Y/N |
| 9 | 고장원인 (FC) | - |
| 10 | O (발생도) | 1-10 |
| 11 | 현 예방관리 | - |
| 12 | 현 검출관리 | - |

### 3.4 고장연결 (Failure Linkage)

**특별 레이아웃**: 3개 테이블 + 연결도
```
┌──────────────────────────────────────────┬────────────────────────────────┐
│  📋 3개 테이블 (좌측 55%)                │  🔗 연결도 (우측 45%)          │
│  ┌────────┬────────┬────────┐           │                                │
│  │FE 목록 │FM 목록 │FC 목록 │           │  고장연결도 (FM 중심)          │
│  │(클릭)  │(선택)  │(클릭)  │           │  ┌──┐   ┌──┐   ┌──┐          │
│  │        │        │        │           │  │FE├───│FM├───│FC│          │
│  └────────┴────────┴────────┘           │  └──┘   └──┘   └──┘          │
│                                          │  SVG 연결선                   │
│                                          ├────────────────────────────────┤
│                                          │  연결 결과 테이블              │
│                                          │  FE | FM | FC (병합)          │
└──────────────────────────────────────────┴────────────────────────────────┘
```

### 3.5 리스크분석 (Risk Analysis) - 40열 전체

**전체 40열 워크시트** (Handsontable)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        P-FMEA 리스크 분석 (전체 40열)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ Step1 구조  │ Step2 기능 │ Step3 고장 │ Step4 연결 │ Step5 리스크 │ Step6-7│
│ (4열)       │ (8열)      │ (10열)     │ (4열)      │ (10열)       │ (4열)  │
├─────────────────────────────────────────────────────────────────────────────┤
│ L1│L2│4M│L3│기능│요구│FE│FM│FC│4M│작업│S│O│D│AP│현예방│현검출│조치│담당│일정│
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 기초정보 모달 연동

### 4.1 모달 트리거
| 셀 타입 | 클릭 시 동작 | 모달 타입 |
|---------|-------------|-----------|
| 완제품공정명 | 🔍 모달 팝업 | 고객정보 선택 |
| 메인공정 | 🔍 모달 팝업 | 공정 라이브러리 |
| 4M | ▼ 드롭다운 | MN/MC/IM/EN |
| 구분 | ▼ 드롭다운 | Your Plant/Ship to/User |
| 담당자 | 🔍 모달 팝업 | 사용자정보 선택 |

### 4.2 다중선택 지원
```
┌─────────────────────────────────────────────────────────┐
│ 🔍 공정 라이브러리 선택                        [X 닫기] │
├─────────────────────────────────────────────────────────┤
│ 검색: [________________] [🔍]                           │
├─────────────────────────────────────────────────────────┤
│ [☑] 10 자재입고                                         │
│ [☑] 11 가온                                             │
│ [☐] 20 수입검사                                         │
│ [☐] 30 배합                                             │
│ [☑] 40 압출                                             │
├─────────────────────────────────────────────────────────┤
│ 선택: 3개                    [취소] [✓ 선택 완료]       │
└─────────────────────────────────────────────────────────┘
```

### 4.3 선택 후 동작
1. **단일 선택**: 해당 셀에 값 입력
2. **다중 선택**: 부모 셀 병합 + 자식 행 생성
   ```
   다중 선택: [10 자재입고, 11 가온, 40 압출]
   
   결과:
   ┌──────────┬──────────┬────┬────────┐
   │ 타이어   │ 10 자재입고│ MN │ 작업자  │
   │ 제조공정 ├──────────┼────┼────────┤
   │ (병합)   │ 11 가온   │ MN │ 작업자  │
   │          ├──────────┼────┼────────┤
   │          │ 40 압출   │ MC │ 압출기  │
   └──────────┴──────────┴────┴────────┘
   ```

---

## 5. 트리 구조 (우측 패널)

### 5.1 계층 구조
```
▾ L1: 타이어 제조 공정                    [+ 추가]
   ├─ ▾ L2: 10 자재입고                   [+ 추가]
   │     ├─ [MN] 00 셋업 엔지니어
   │     ├─ [MN] 00 작업자
   │     ├─ [MC] 10 자동창고
   │     └─ [EN] 00 온도
   ├─ ▾ L2: 11 가온
   │     ├─ [MN] 00 작업자
   │     └─ [MC] 11 가온실
   └─ ▾ L2: 20 수입검사
         ├─ [MN] 00 검사원
         └─ [MC] 20 MOONEY VISCOMETER
```

### 5.2 트리 ↔ 워크시트 양방향 동기화
- 트리에서 노드 선택 → 워크시트 해당 행 하이라이트
- 워크시트에서 셀 선택 → 트리 해당 노드 하이라이트
- 트리에서 추가/삭제 → 워크시트 즉시 반영
- 워크시트에서 편집 → 트리 즉시 반영

---

## 6. 전체보기 패널 (우측)

### 6.1 40열 미니 워크시트
```
┌──────────────────────────────────────────────────────────────┐
│ 📊 전체 워크시트 미리보기                    진행률: 35%     │
├──────────────────────────────────────────────────────────────┤
│ ██████████████░░░░░░░░░░░░░░░░░░░░░░░░░░ 35%                │
├──────────────────────────────────────────────────────────────┤
│ │1│2│3│4│5│6│7│8│9│10│11│12│...│38│39│40│                   │
│ ├─┼─┼─┼─┼─┼─┼─┼─┼─┼──┼──┼──┼...┼──┼──┼──┤                   │
│ │✓│✓│✓│✓│✓│✓│ │ │ │  │  │  │...│  │  │  │ ← 입력완료: 파랑 │
│ │✓│✓│✓│✓│✓│✓│ │ │ │  │  │  │...│  │  │  │ ← 미입력: 회색   │
│ │✓│✓│✓│✓│ │ │ │ │ │  │  │  │...│  │  │  │                   │
└──────────────────────────────────────────────────────────────┘
```

### 6.2 단계별 색상 표시
| 열 범위 | 단계 | 색상 |
|---------|------|------|
| 1-4 | 구조분석 | 🟦 파랑 |
| 5-12 | 기능분석 | 🟩 초록 |
| 13-24 | 고장분석 | 🟨 노랑 |
| 25-30 | 고장연결 | 🟧 주황 |
| 31-36 | 리스크분석 | 🟥 빨강 |
| 37-40 | 최적화 | 🟪 보라 |

---

## 7. 데이터 모델

### 7.1 핵심 인터페이스
```typescript
interface FMEAWorksheetData {
  id: string;
  projectId: string;
  
  // L1: 완제품공정
  l1: {
    id: string;
    name: string;        // 완제품공정명
    function: string;    // 완제품기능
  };
  
  // L2: 메인공정 (배열)
  l2: L2Process[];
  
  // 메타데이터
  createdAt: string;
  updatedAt: string;
}

interface L2Process {
  id: string;
  no: string;           // 공정번호 (10, 11, 20...)
  name: string;         // 공정명
  function: string;     // 공정기능
  requirement: string;  // 공정요구사항
  
  // L3: 작업요소 (배열)
  l3: L3WorkElement[];
  
  // 고장분석 데이터
  failures: FailureData[];
}

interface L3WorkElement {
  id: string;
  m4: 'MN' | 'MC' | 'IM' | 'EN';  // 4M 구분
  name: string;                    // 작업요소명
  function: string;                // 작업요소기능
  requirement: string;             // 작업요소요구
  
  // 고장원인 (배열)
  causes: FailureCause[];
}

interface FailureData {
  id: string;
  scope: 'Your Plant' | 'Ship to Plant' | 'User';
  fe: string;          // 고장영향
  fm: string;          // 고장형태
  severity: number;    // 심각도 (1-10)
  fmSC: boolean;       // 특별특성 여부
  specialChar?: string; // 특별특성 기호 (IC, CC, BM-F 등)
}

interface FailureCause {
  id: string;
  fc: string;          // 고장원인
  occurrence: number;  // 발생도 (1-10)
  detection: number;   // 검출도 (1-10)
  prevention: string;  // 현 예방관리
  detection: string;   // 현 검출관리
  ap: 'H' | 'M' | 'L'; // Action Priority
}
```

---

## 8. 개발 우선순위

### Phase 1: 기본 레이아웃 (1일) ✅ 완료
- [x] 공통 레이아웃 컴포넌트 (상단바, 탭메뉴, 트리패널)
- [x] 탭 메뉴 + 레벨 선택 (1L/2L/3L/All)
- [x] 좌측/우측 패널 분할 (독립 스크롤)
- [x] 바로가기 네비게이션 (등록/리스트/작성화면/개정관리)
- [x] FMEA 선택 드롭다운 (빈화면 옵션 포함)

### Phase 2: 구조분석 (1일) ✅ 완료
- [x] Level 1/2/3 워크시트
- [x] 셀 병합 (rowspan) 로직 - 완제품공정명, 메인공정 1:1 매칭
- [x] 기초정보 모달 연동 (공정선택, 작업요소 선택)
- [x] 4M 드롭다운 (MN/MC/MT/EN)
- [x] 인라인 편집 (클릭하여 수정/저장)
- [x] Excel Export 기능
- [x] Excel Import 기능
- [x] 템플릿 다운로드

### Phase 3: 기능 분석 (Step 3) - 레벨별 독립 분석 ✅ 구조 개편
- **3.1 L1 완제품 기능분석**: 완제품 수준의 기능 및 요구사항 정의 (Atomic ID 부여)
- **3.2 L2 메인공정 기능분석**: 각 공정별 기능 및 제품특성 정의
- **3.3 L3 작업요소 기능분석**: 4M 요소별 세부 기능 및 공정특성 정의
- **원자성 확보**: 모든 기능/특성 데이터는 고유 ID를 가져 '고장연결(Step 4)'에서 참조 가능하도록 구성

### Phase 3.5: 특별특성 마스터 등록 ✅ 완료
- **SpecialCharMasterModal**: 고객별 특별특성 기호 등록/관리
  - 고객: 현대/기아, BMW, FORD, GM 등
  - 기호: IC, CC, BM-F, BM-C, OS, YC 등
  - 자사 표시: SC(Safety/Critical), FF(Fit/Function)
- **FMEA 기초정보 연동**: 부품, 공정, 제품특성, 공정특성 선택
- **문서 연동 설정**: D-FMEA, P-FMEA, CP, PFD 자동 연동
- **Excel Export/Import**: 마스터 데이터 일괄 관리
- **UI 규칙**: 저장/취소 버튼 상단 우측 배치

### Phase 4: 고장 분석 (Step 4) ✅ 개발 진행중
- **4.1 1L 고장영향 (Failure Effect)**: 요구사항별 고장영향 및 심각도 정의
- **4.2 2L 고장형태 (Failure Mode)**: 공정기능별 고장형태 정의
- **4.3 3L 고장원인 (Failure Cause)**: 작업요소별 고장원인 정의

### Phase 4.5: SOD 기준표 마스터 등록 ✅ 완료
- **SODMasterModal**: P-FMEA/D-FMEA 심각도/발생도/검출도 기준표 관리
  - AIAG & VDA FMEA Handbook 기준 (한글/영문 병기)
  - P-FMEA: 심각도 3열, 발생도 3열, 검출도 2열
  - D-FMEA: 심각도 1열, 발생도 2열, 검출도 2열
  - 위험도 기반 색상 (10=적색, 1=녹색)
- **SODSelectModal**: 워크시트에서 SOD 값 선택용 팝업
- **수정/저장 토글**: 보기모드 ↔ 수정모드 전환
- **Excel Export/Import**: 마스터 데이터 일괄 관리

### Phase 5: 고장연결 (1일)
- [ ] 3테이블 레이아웃
- [ ] SVG 연결선
- [ ] 연결 결과 테이블

### Phase 6: 리스크분석 (2일)
- [ ] Handsontable 40열
- [ ] AP 자동계산
- [ ] 전체보기 미니맵

### Phase 7: 최적화 & 문서화 (1일)
- [ ] 개선조치 입력
- [x] Excel Export (구조분석 완료)
- [ ] 보고서 생성

---

## 9. 테스트 URL

| 화면 | URL |
|------|-----|
| FMEA 워크시트 | `/pfmea/worksheet` |
| 구조분석 | `/pfmea/worksheet?tab=structure` |
| 기능분석 | `/pfmea/worksheet?tab=function` |
| 고장분석 | `/pfmea/worksheet?tab=failure` |
| 고장연결 | `/pfmea/worksheet?tab=linkage` |
| 리스크분석 | `/pfmea/worksheet?tab=risk` |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| v1.0.0 | 2025-12-26 | 초안 작성 |
| v1.1.0 | 2025-12-27 | Phase 1, 2 완료 - 기본 레이아웃, 구조분석 개발 |
| v1.1.1 | 2025-12-27 | Excel Export/Import, 템플릿, 빈화면 옵션 추가 |
| v1.2.0 | 2025-12-28 | Phase 3 기능분석 트리 구조, 데이터 원자성 확보 |
| v1.3.0 | 2025-12-28 | 구조분석 개선 - 작업요소 삭제 기능, 모달 UX 개선 |
| v1.4.0 | 2025-12-28 | 특별특성 마스터 등록 모달 개발 |
| v1.5.0 | 2025-12-28 | 고장분석 개발, SOD 기준표 마스터 모달 개발 완료 |

### v1.5.0 주요 변경사항

#### 1. SOD 기준표 마스터 등록 모달
| 항목 | 설명 |
|------|------|
| P-FMEA 심각도 | 3열 (Your Plant, Ship-to-Plant, End User) |
| P-FMEA 발생도 | 3열 (관리유형, 예방관리, 대안1) - 노란색/빨간색 구분 |
| P-FMEA 검출도 | 2열 (검출방법, 검출기회) - 등급1 셀병합 |
| D-FMEA 심각도 | 1열 (DFMEA 심각도 기준) |
| D-FMEA 발생도 | 2열 (발생도 기준, 대안1) |
| D-FMEA 검출도 | 2열 (검출방법, 검출기회) - 등급1 셀병합 |

#### 2. 수정/저장 토글 기능
| 모드 | 버튼 | 동작 |
|------|------|------|
| 보기모드 | ✏️ 수정 | 읽기 전용, 수정 버튼 클릭 시 수정모드 전환 |
| 수정모드 | 💾 저장 / 취소 | 셀 편집 가능, 파란색 테두리 표시 |

#### 3. 고장분석 탭 개발
- 1L 고장영향 (FailureL1Tab): 요구사항별 고장영향 + 심각도
- 2L 고장형태 (FailureL2Tab): 공정기능별 고장형태
- 3L 고장원인 (FailureL3Tab): 작업요소별 고장원인

#### 4. 한글/영문 병기
- AIAG & VDA FMEA Handbook 기준 적용
- 한글: 검정색, 영문: 파란색 이탤릭

### v1.3.0 주요 변경사항

#### 1. 완제품 공정명-메인 공정명 1:1 병합
- `l2Spans` 기준으로 두 컬럼 동일하게 병합
- 스크롤 시에도 정상 표시

#### 2. 4M 코드 변경
- `MT` → `IM` (In Material) 전체 변경
- 데이터 마이그레이션 로직 추가 (useWorksheetState)

#### 3. 작업요소 셀 UX 개선
| 동작 | 기능 |
|------|------|
| 클릭 | 모달 팝업 (추가/삭제/선택) |
| 더블클릭 | 인라인 텍스트 수정 ✏️ |

#### 4. 공정/작업요소 모달 삭제 기능 추가
- 🗑️ 삭제 버튼 눈에 띄게 변경 (빨간색)
- 삭제 모드 토글 및 선택 삭제 기능
- (현재) 표시된 항목만 개별 삭제 가능


