# CP 워크시트 행추가/삭제/병합 규칙

**작성일**: 2026-01-16  
**적용 대상**: Control Plan 워크시트 (`/control-plan/worksheet`)

---

## 핵심 원칙

### 행추가 규칙

| 원칙 | 설명 |
|------|------|
| **트리거 열** | 행추가가 발생하는 열은 **병합 없음** (빈 값으로 추가) |
| **상위 열** | 하위에서 행추가 시 **확장병합됨** (현재 행 값 복사) |
| **하위 열** | 단순 행추가 (빈 값) |

---

## 열별 행추가 동작

### A, B열 (공정번호, 공정명) - 최상위

```
A, B열에서 행추가 시:
├── A, B열: 고유값 생성 → 병합 안 됨
└── C~S열: 빈 값 → 단순 행추가
```

**동작**: 완전히 새로운 공정 행 생성 (모든 열 병합 안 됨)

---

### D열 (공정설명)

```
D열에서 행추가 시:
├── A, B열 (상위): 현재 행 값 복사 → 확장병합됨
├── C, D열 (자신): 고유값 생성 → 병합 안 됨 ★
└── E~S열 (하위): 빈 값 → 단순 행추가
```

**동작**: 같은 공정 내 새 공정설명 행 추가  
**★ 중요**: C, D열은 고유값(`_timestamp_random`)으로 병합 방지

---

### E열 (설비/금형/JIG)

```
E열에서 행추가 시:
├── A, B열 (할아버지): 현재 행 값 복사 → 확장병합됨
├── C, D열 (부모): 현재 행 값 복사 → 확장병합됨
├── E열 (자신): 빈 값 → 병합 안 됨
└── F~S열 (하위): 빈 값 → 단순 행추가
```

**동작**: 같은 공정설명 내 새 설비 행 추가

---

### I열 (제품특성)

```
I열에서 행추가 시:
├── A, B열 (상위): 현재 행 값 복사 → 확장병합됨
├── C, D열 (상위): 현재 행 값 복사 → 확장병합됨
├── E열 (상위): 현재 행 값 복사 → 확장병합됨 ★
├── I열 (자신): 빈 값 → 병합 안 됨
└── J~S열 (하위): 빈 값 → 단순 행추가
```

**동작**: 같은 설비 내 새 제품특성 행 추가  
**★ 중요**: I열에서 행추가 시 **E열도 병합됨** (E열은 상위이므로)

---

## 병합(rowSpan) 계산 로직

### 병합 조건

| 열 | 병합 기준 | 빈 값 처리 |
|---|---|---|
| **A, B열** | `processNo + processName` | 빈 값도 병합 |
| **C, D열** | `A+B + processLevel + processDesc` | 키가 같으면 병합 (D열에서 행추가 시 고유값으로 방지) |
| **E열** | `A+B+C+D + workElement` | E열 빈 값 → 병합 안 됨 |
| **I열** | `A+B+C+D+E + productChar` | I열 빈 값 → 병합 안 됨 |

### 병합 판단 흐름

```
같은 그룹의 연속 행인가?
├── 예 → 자신 열이 빈 값인가?
│       ├── 예 → 병합 안 됨 (span=1)
│       └── 아니오 → 병합됨 (span 증가)
└── 아니오 → 병합 안 됨 (span=1)
```

---

## 행 삭제 규칙

| 조건 | 동작 |
|------|------|
| 마지막 1행 | 삭제 불가 (경고 메시지) |
| 병합된 행의 첫 행 삭제 | 병합 해제, 다음 행이 첫 행이 됨 |
| 병합된 행의 중간/끝 행 삭제 | 병합 span 감소 |

---

## 관련 코드 파일

| 파일 | 역할 |
|------|------|
| `hooks/useWorksheetHandlers.ts` | 행추가/삭제 핸들러 |
| `hooks/useRowSpan.ts` | rowSpan 계산 훅 |
| `renderers/index.tsx` | 셀 렌더링 (rowSpan 적용) |

### rowSpan 훅 목록

```typescript
useProcessRowSpan(items)  // A, B열 병합
useDescRowSpan(items)     // C, D열 병합
useWorkRowSpan(items)     // E열 병합
useCharRowSpan(items)     // I열 병합
```

---

## 예시: I열에서 행추가

**Before:**
| A | B | C | D | E | ... | I |
|---|---|---|---|---|-----|---|
| 10 | 입고 | L1 | 입고 확인 | 입고대 | ... | 두께 |

**After (I열에서 행추가):**
| A | B | C | D | E | ... | I |
|---|---|---|---|---|-----|---|
| 10 | 입고 | L1 | 입고 확인 | 입고대 | ... | 두께 |
| ↑병합 | ↑병합 | ↑병합 | ↑병합 | ↑병합 | ... | (빈값) |

- A, B, C, D, E열: 상위이므로 **확장병합**
- I열: 트리거 열이므로 **병합 안 됨**
- J~S열: 하위이므로 **빈 값**

---

## 변경 이력

| 날짜 | 내용 |
|------|------|
| 2026-01-16 | E열 행추가 시 C, D열 확장병합 수정, D열 행추가 시 고유값으로 병합 방지 |
| 2026-01-16 | 문서 작성, 행추가 규칙 정의 |
| 2026-01-12 | I열 행추가 시 상위 병합 유지 기능 추가 |

---

**작성자**: AI Assistant  
**검토일**: 2026-01-16
