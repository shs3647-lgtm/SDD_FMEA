// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============ 프로젝트 (최상위) ============

model APQPProject {
  id          String   @id @default(uuid())
  name        String
  productName String
  customerName String
  status      String   // 'planning' | 'development' | 'production' | 'closed'
  startDate   String?
  targetDate  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Note: FMEA 데이터는 fmeaId (String)로 연결되며, 직접 FK 관계가 아닙니다
  // fmeaId는 APQPProject.id와 매칭되지만, Prisma relation으로는 정의하지 않습니다

  @@map("apqp_projects")
}

// ============ 구조분석 (2단계) - Structure Tables ============

model L1Structure {
  id        String   @id @default(uuid())
  fmeaId    String   // FK: FMEA 프로젝트 ID (APQPProject.id 또는 별도 FMEA ID)
  name      String   // 완제품 공정명
  confirmed Boolean? @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ★★★ 하이브리드 ID 시스템 필드 ★★★
  parentId     String?  // 부모 ID (모자관계 추적)
  mergeGroupId String?  // 병합 그룹 ID
  rowSpan      Int?     @default(1) // 병합된 행 수
  colSpan      Int?     @default(1) // 병합된 열 수

  // Relations
  l2Structures L2Structure[]
  l1Functions  L1Function[]

  @@index([fmeaId])
  @@index([parentId])
  @@index([mergeGroupId])
  @@map("l1_structures")
}

model L2Structure {
  id        String   @id @default(uuid())
  fmeaId    String   // FK: FMEA 프로젝트 ID
  l1Id      String   // FK: L1Structure.id
  no        String   // 공정 번호
  name      String   // 공정명
  order     Int      // 순서
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ★★★ 하이브리드 ID 시스템 필드 ★★★
  parentId     String?  // 부모 ID (모자관계 추적)
  mergeGroupId String?  // 병합 그룹 ID
  rowSpan      Int?     @default(1)
  colSpan      Int?     @default(1)

  // Relations
  l1Structure L1Structure @relation(fields: [l1Id], references: [id], onDelete: Cascade)
  l3Structures L3Structure[]
  l2Functions  L2Function[]
  failureModes FailureMode[]

  @@index([fmeaId])
  @@index([l1Id])
  @@index([parentId])
  @@index([mergeGroupId])
  @@map("l2_structures")
}

model L3Structure {
  id        String   @id @default(uuid())
  fmeaId    String   // FK: FMEA 프로젝트 ID
  l1Id      String   // FK: L1Structure.id (연결용)
  l2Id      String   // FK: L2Structure.id
  m4        String?  // 4M 분류: 'MN' | 'MC' | 'IM' | 'EN' | ''
  name      String   // 작업요소명
  order     Int      // 순서
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ★★★ 하이브리드 ID 시스템 필드 ★★★
  parentId     String?  // 부모 ID (모자관계 추적)
  mergeGroupId String?  // 병합 그룹 ID
  rowSpan      Int?     @default(1)
  colSpan      Int?     @default(1)

  // Relations
  l2Structure L2Structure @relation(fields: [l2Id], references: [id], onDelete: Cascade)
  l3Functions  L3Function[]
  failureCauses FailureCause[]

  @@index([fmeaId])
  @@index([l1Id])
  @@index([l2Id])
  @@index([parentId])
  @@index([mergeGroupId])
  @@map("l3_structures")
}

// ============ 기능분석 (3단계) - Function Tables ============

model L1Function {
  id           String   @id @default(uuid())
  fmeaId       String   // FK: FMEA 프로젝트 ID
  l1StructId   String   // FK: L1Structure.id
  category     String   // 'Your Plant' | 'Ship to Plant' | 'User'
  functionName String   // 기능명
  requirement  String   // 요구사항
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // ★★★ 하이브리드 ID 시스템 필드 ★★★
  parentId     String?
  mergeGroupId String?
  rowSpan      Int?     @default(1)
  colSpan      Int?     @default(1)

  // Relations
  l1Structure   L1Structure @relation(fields: [l1StructId], references: [id], onDelete: Cascade)
  failureEffects FailureEffect[]

  @@index([fmeaId])
  @@index([l1StructId])
  @@index([parentId])
  @@index([mergeGroupId])
  @@map("l1_functions")
}

model L2Function {
  id           String   @id @default(uuid())
  fmeaId       String   // FK: FMEA 프로젝트 ID
  l2StructId   String   // FK: L2Structure.id
  functionName String   // 기능명
  productChar  String   // 제품특성
  specialChar  String?  // 특별특성
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // ★★★ 하이브리드 ID 시스템 필드 ★★★
  parentId     String?
  mergeGroupId String?
  rowSpan      Int?     @default(1)
  colSpan      Int?     @default(1)

  // Relations
  l2Structure L2Structure @relation(fields: [l2StructId], references: [id], onDelete: Cascade)
  failureModes FailureMode[]

  @@index([fmeaId])
  @@index([l2StructId])
  @@index([parentId])
  @@index([mergeGroupId])
  @@map("l2_functions")
}

model L3Function {
  id           String   @id @default(uuid())
  fmeaId       String   // FK: FMEA 프로젝트 ID
  l3StructId   String   // FK: L3Structure.id
  l2StructId   String   // FK: L2Structure.id (연결용)
  functionName String   // 기능명
  processChar  String   // 공정특성
  specialChar  String?  // 특별특성
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // ★★★ 하이브리드 ID 시스템 필드 ★★★
  parentId     String?
  mergeGroupId String?
  rowSpan      Int?     @default(1)
  colSpan      Int?     @default(1)

  // Relations
  l3Structure L3Structure @relation(fields: [l3StructId], references: [id], onDelete: Cascade)
  failureCauses FailureCause[]

  @@index([fmeaId])
  @@index([l3StructId])
  @@index([l2StructId])
  @@index([parentId])
  @@index([mergeGroupId])
  @@map("l3_functions")
}

// ============ 고장분석 (4단계) - Failure Tables ============

model FailureEffect {
  id        String   @id @default(uuid())
  fmeaId    String   // FK: FMEA 프로젝트 ID
  l1FuncId  String   // FK: L1Function.id
  category  String   // 'Your Plant' | 'Ship to Plant' | 'User'
  effect    String   // 고장영향 내용
  severity  Int      // 심각도 (1-10)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ★★★ 하이브리드 ID 시스템 필드 ★★★
  parentId     String?
  mergeGroupId String?
  rowSpan      Int?     @default(1)
  colSpan      Int?     @default(1)

  // Relations
  l1Function L1Function @relation(fields: [l1FuncId], references: [id], onDelete: Cascade)
  failureLinks FailureLink[]

  @@index([fmeaId])
  @@index([l1FuncId])
  @@index([parentId])
  @@index([mergeGroupId])
  @@map("failure_effects")
}

model FailureMode {
  id            String   @id @default(uuid())
  fmeaId        String   // FK: FMEA 프로젝트 ID
  l2FuncId      String   // FK: L2Function.id
  l2StructId    String   // FK: L2Structure.id (역전개용)
  productCharId String?  // FK: 제품특성 연결용
  mode          String   // 고장형태 내용
  specialChar   Boolean? @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // ★★★ 하이브리드 ID 시스템 필드 ★★★
  parentId     String?
  mergeGroupId String?
  rowSpan      Int?     @default(1)
  colSpan      Int?     @default(1)

  // Relations
  l2Function L2Function @relation(fields: [l2FuncId], references: [id], onDelete: Cascade)
  l2Structure L2Structure @relation(fields: [l2StructId], references: [id], onDelete: Cascade)
  failureLinks FailureLink[]

  @@index([fmeaId])
  @@index([l2FuncId])
  @@index([l2StructId])
  @@index([parentId])
  @@index([mergeGroupId])
  @@map("failure_modes")
}

model FailureCause {
  id           String   @id @default(uuid())
  fmeaId       String   // FK: FMEA 프로젝트 ID
  l3FuncId     String   // FK: L3Function.id
  l3StructId   String   // FK: L3Structure.id (역전개용)
  l2StructId   String   // FK: L2Structure.id (연결용)
  processCharId String?  // FK: 공정특성 연결용
  cause        String   // 고장원인 내용
  occurrence   Int?     // 발생도 (1-10)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // ★★★ 하이브리드 ID 시스템 필드 ★★★
  parentId     String?
  mergeGroupId String?
  rowSpan      Int?     @default(1)
  colSpan      Int?     @default(1)

  // Relations
  l3Function L3Function @relation(fields: [l3FuncId], references: [id], onDelete: Cascade)
  l3Structure L3Structure @relation(fields: [l3StructId], references: [id], onDelete: Cascade)
  failureLinks FailureLink[]

  @@index([fmeaId])
  @@index([l3FuncId])
  @@index([l3StructId])
  @@index([l2StructId])
  @@index([parentId])
  @@index([mergeGroupId])
  @@map("failure_causes")
}

// =========================================================
// ============ PFMEA 기초정보 마스터 데이터 (공통) ============
// =========================================================

model PfmeaMasterDataset {
  id          String   @id @default(uuid())
  name        String
  isActive    Boolean  @default(false)
  relationData Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  flatItems   PfmeaMasterFlatItem[]

  @@index([isActive])
  @@map("pfmea_master_datasets")
}

model PfmeaMasterFlatItem {
  id          String   @id @default(uuid())
  datasetId   String
  processNo   String
  category    String   // 'A' | 'B' | 'C'
  itemCode    String   // A1~A6, B1~B5, C1~C4
  value       String
  sourceFmeaId String?
  createdAt   DateTime @default(now())

  dataset     PfmeaMasterDataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@index([datasetId])
  @@unique([datasetId, processNo, itemCode, value])
  @@map("pfmea_master_flat_items")
}

model FailureLink {
  id        String   @id @default(uuid())
  fmeaId    String   // FK: FMEA 프로젝트 ID
  fmId      String   // FK: FailureMode.id (중심축)
  feId      String   // FK: FailureEffect.id
  fcId      String   // FK: FailureCause.id
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ★★★ 하이브리드 ID: {FMEA_SEQ}-LK-FM{SEQ}-FE{SEQ}-FC{SEQ} ★★★
  fmSeq    Int?     // FM 순번 (ID에서 추출 가능)
  feSeq    Int?     // FE 순번 (ID에서 추출 가능)
  fcSeq    Int?     // FC 순번 (ID에서 추출 가능)
  fmPath   String?  // FM 경로 (역전개 추적용)
  fePath   String?  // FE 경로 (역전개 추적용)
  fcPath   String?  // FC 경로 (역전개 추적용)

  // ★★★ 하이브리드 ID 시스템 필드 ★★★
  parentId     String?
  mergeGroupId String?
  rowSpan      Int?     @default(1)
  colSpan      Int?     @default(1)

  // Relations
  failureMode   FailureMode   @relation(fields: [fmId], references: [id], onDelete: Cascade)
  failureEffect FailureEffect @relation(fields: [feId], references: [id], onDelete: Cascade)
  failureCause  FailureCause  @relation(fields: [fcId], references: [id], onDelete: Cascade)
  riskAnalyses  RiskAnalysis[]
  failureAnalyses FailureAnalysis[] // 고장분석 통합 데이터

  @@index([fmeaId])
  @@index([fmId])
  @@index([feId])
  @@index([fcId])
  @@index([parentId])
  @@index([mergeGroupId])
  @@map("failure_links")
}

// ============ 고장분석 통합 테이블 (All 화면 렌더링용) ============
// 고장연결 결과 + 역전개 기능분석 + 역전개 구조분석 통합 저장

model FailureAnalysis {
  id        String   @id @default(uuid())
  fmeaId    String   // FK: FMEA 프로젝트 ID
  linkId    String   // FK: FailureLink.id (고장연결)
  
  // ============ 고장연결 정보 (고장형태, 고장원인, 고장영향) ============
  fmId      String   // FK: FailureMode.id
  fmText    String   // 고장형태 내용
  fmProcessName String // 공정명 (L2 Structure.name)
  
  feId      String   // FK: FailureEffect.id
  feText    String   // 고장영향 내용
  feCategory String  // 구분 (Your Plant/Ship to Plant/User)
  feSeverity Int     // 심각도 (1-10)
  
  fcId      String   // FK: FailureCause.id
  fcText    String   // 고장원인 내용
  fcOccurrence Int?  // 발생도 (1-10)
  fcWorkElementName String // 작업요소명 (L3 Structure.name)
  fcM4      String?  // 4M 분류 (MN/MC/IM/EN)
  
  // ============ 역전개 기능분석 정보 ============
  // L1 (완제품 기능)
  l1FuncId      String   // FK: L1Function.id
  l1Category    String   // 구분 (Your Plant/Ship to Plant/User)
  l1FuncName    String   // 완제품 기능명
  l1Requirement String   // 요구사항
  
  // L2 (메인공정 기능)
  l2FuncId      String   // FK: L2Function.id
  l2FuncName    String   // 공정 기능명
  l2ProductChar String   // 제품특성
  l2SpecialChar String?  // 특별특성
  
  // L3 (작업요소 기능)
  l3FuncId      String   // FK: L3Function.id
  l3FuncName    String   // 작업요소 기능명
  l3ProcessChar String   // 공정특성
  l3SpecialChar String?  // 특별특성
  
  // ============ 역전개 구조분석 정보 ============
  // L1 (완제품)
  l1StructId    String   // FK: L1Structure.id
  l1StructName  String   // 완제품 공정명
  
  // L2 (메인공정)
  l2StructId    String   // FK: L2Structure.id
  l2StructNo    String   // 공정 번호
  l2StructName  String   // 공정명
  
  // L3 (작업요소)
  l3StructId    String   // FK: L3Structure.id
  l3StructM4    String?  // 4M 분류
  l3StructName  String   // 작업요소명
  
  // ============ 메타데이터 ============
  order       Int      @default(0) // 정렬 순서
  confirmed   Boolean  @default(false) // 확정 여부
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  failureLink FailureLink @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@index([fmeaId])
  @@index([linkId])
  @@index([fmId])
  @@index([feId])
  @@index([fcId])
  @@unique([linkId]) // 하나의 고장연결당 하나의 고장분석 데이터
  @@map("failure_analyses")
}

// ============ 리스크분석/최적화 (5-6단계) ============

model RiskAnalysis {
  id                String   @id @default(uuid())
  fmeaId            String   // FK: FMEA 프로젝트 ID
  linkId            String   // FK: FailureLink.id
  severity          Int      // 심각도 (1-10)
  occurrence       Int      // 발생도 (1-10)
  detection         Int      // 검출도 (1-10)
  ap                String   // 'H' | 'M' | 'L'
  preventionControl String?  // 예방관리
  detectionControl  String?  // 검출관리
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  failureLink  FailureLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  optimizations Optimization[]

  @@index([fmeaId])
  @@index([linkId])
  @@map("risk_analyses")
}

model Optimization {
  id               String   @id @default(uuid())
  fmeaId           String   // FK: FMEA 프로젝트 ID
  riskId           String   // FK: RiskAnalysis.id
  recommendedAction String   // 권고 조치
  responsible      String   // 담당자
  targetDate       String   // YYYY-MM-DD
  newSeverity      Int?     // 개선 후 S
  newOccurrence    Int?     // 개선 후 O
  newDetection     Int?     // 개선 후 D
  newAP            String?  // 개선 후 AP
  status           String   // 'planned' | 'in_progress' | 'completed'
  completedDate    String?  // YYYY-MM-DD
  remarks          String?  // 비고
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  riskAnalysis RiskAnalysis @relation(fields: [riskId], references: [id], onDelete: Cascade)

  @@index([fmeaId])
  @@index([riskId])
  @@map("optimizations")
}

// ============================================================================
// ============ FMEA 프로젝트 관리 테이블들 (화면별 분리) ============
// ============================================================================

// ============ 1. FMEA 프로젝트 기본 정보 (리스트 화면용) ============
model FmeaProject {
  id              String   @id @default(uuid())
  fmeaId          String   @unique // PFM26-M001 형식
  fmeaType        String   @default("P") // 'M' | 'F' | 'P' (Master/Family/Part)
  parentFmeaId    String?  // 상위 FMEA ID (Master는 본인 ID)
  parentFmeaType  String?  // 상위 FMEA 유형
  status          String   @default("active") // 'active' | 'archived' | 'deleted'
  step            Int      @default(1) // 현재 단계 (1-7)
  revisionNo      String   @default("Rev.01")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  registration    FmeaRegistration?
  cftMembers      FmeaCftMember[]
  worksheetData   FmeaWorksheetData?
  // confirmedState는 논리적 연결 (fmeaId로 조인)

  @@index([fmeaType])
  @@index([parentFmeaId])
  @@index([status])
  @@map("fmea_projects")
}

// ============ 2. FMEA 등록 정보 (등록화면 - 기획 및 준비 1단계) ============
model FmeaRegistration {
  id                    String   @id @default(uuid())
  fmeaId                String   @unique // FK: FmeaProject.fmeaId
  companyName           String?  // 회사명
  engineeringLocation   String?  // 엔지니어링 위치
  customerName          String?  // 고객명
  modelYear             String?  // 모델 연식/플랫폼
  subject               String?  // FMEA명 (주제)
  fmeaStartDate         String?  // 시작일자 (YYYY-MM-DD)
  fmeaRevisionDate      String?  // 개정일자 (YYYY-MM-DD)
  fmeaProjectName       String?  // 프로젝트명
  designResponsibility  String?  // 공정책임 (부서)
  confidentialityLevel  String?  // 기밀유지수준
  fmeaResponsibleName   String?  // 담당자 성명
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  project FmeaProject @relation(fields: [fmeaId], references: [fmeaId], onDelete: Cascade)

  @@index([fmeaId])
  @@map("fmea_registrations")
}

// ============ 3. CFT 멤버 정보 (등록화면 - CFT 리스트) ============
model FmeaCftMember {
  id             String   @id @default(uuid())
  fmeaId         String   // FK: FmeaProject.fmeaId
  role           String   // 역할: 'Champion' | 'Leader' | 'PM' | 'Moderator' | 'CFT 팀원'
  name           String?  // 성명
  department     String?  // 부서
  position       String?  // 직급
  responsibility String?  // 담당업무
  email          String?  // 이메일
  phone          String?  // 전화번호
  remarks        String?  // 비고
  order          Int      @default(0) // 순서
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  project FmeaProject @relation(fields: [fmeaId], references: [fmeaId], onDelete: Cascade)

  @@index([fmeaId])
  @@index([role])
  @@map("fmea_cft_members")
}

// ============ 4. 워크시트 데이터 (워크시트 화면용) ============
model FmeaWorksheetData {
  id           String   @id @default(uuid())
  fmeaId       String   @unique // FK: FmeaProject.fmeaId
  l1Data       Json?    // L1 구조 데이터 (완제품 공정명, failureScopes 등)
  l2Data       Json?    // L2 공정 배열 데이터
  riskData     Json?    // 리스크분석/최적화 데이터
  failureLinks Json?    // 고장연결 데이터
  tab          String?  // 현재 탭
  version      String   @default("1.0.0")
  savedAt      DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  project FmeaProject @relation(fields: [fmeaId], references: [fmeaId], onDelete: Cascade)

  @@index([fmeaId])
  @@map("fmea_worksheet_data")
}

// ============ 레거시 데이터 (하위호환용 - 점진적 마이그레이션) ============
// 원자성 DB와의 불일치 방지를 위해 레거시 형식을 JSON으로 직접 저장

model FmeaLegacyData {
  id        String   @id @default(uuid())
  fmeaId    String   @unique // FK: FMEA 프로젝트 ID (1:1 관계)
  data      Json     // 레거시 WorksheetState 전체를 JSON으로 저장
  version   String   @default("1.0.0") // 스키마 버전
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fmeaId])
  @@map("fmea_legacy_data")
}

// ============ 5. 확정 상태 (단계별 확정 상태 저장) ============

model FmeaConfirmedState {
  id                   String   @id @default(uuid())
  fmeaId               String   @unique // FK: FmeaProject.fmeaId (논리적 연결)
  structureConfirmed   Boolean  @default(false)  // 구조분석 확정
  l1FunctionConfirmed  Boolean  @default(false)  // 1L 기능분석 확정
  l2FunctionConfirmed  Boolean  @default(false)  // 2L 기능분석 확정
  l3FunctionConfirmed  Boolean  @default(false)  // 3L 기능분석 확정
  failureL1Confirmed   Boolean  @default(false)  // 1L 고장영향 확정
  failureL2Confirmed   Boolean  @default(false)  // 2L 고장형태 확정
  failureL3Confirmed   Boolean  @default(false)  // 3L 고장원인 확정
  failureLinkConfirmed Boolean  @default(false)  // 고장연결 확정
  riskConfirmed        Boolean  @default(false)  // 리스크분석 확정
  optimizationConfirmed Boolean @default(false)  // 최적화 확정
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Note: FK relation은 데이터 마이그레이션 후 추가 예정
  // project FmeaProject @relation(fields: [fmeaId], references: [fmeaId], onDelete: Cascade)

  @@map("fmea_confirmed_states")
}

// ============ 6. 개정 이력 (개정관리 화면) ============
model FmeaRevisionHistory {
  id              String   @id @default(uuid())
  fmeaId          String   // FK: FmeaProject.fmeaId
  revisionNumber  String   // Rev.00, Rev.01, Rev.02...
  revisionHistory String?  // 개정이력 설명
  
  // 작성
  createPosition  String?  // 작성자 직급
  createName      String?  // 작성자 성명
  createDate      String?  // 작성일자
  createStatus    String?  // 진행/승인/반려
  
  // 검토
  reviewPosition  String?  // 검토자 직급
  reviewName      String?  // 검토자 성명
  reviewDate      String?  // 검토일자
  reviewStatus    String?  // 진행/승인/반려
  
  // 승인
  approvePosition String?  // 승인자 직급
  approveName     String?  // 승인자 성명
  approveDate     String?  // 승인일자
  approveStatus   String?  // 진행/승인/반려
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([fmeaId])
  @@index([revisionNumber])
  @@map("fmea_revision_history")
}

// ============ 7. 회의록 (개정관리 화면) ============
model FmeaMeetingMinute {
  id            String   @id @default(uuid())
  fmeaId        String   // FK: FmeaProject.fmeaId
  no            Int      // 회의록 번호
  date          String?  // 회의일자
  projectName   String?  // 프로젝트명
  content       String?  // 회의내용
  author        String?  // 작성자
  authorPosition String? // 작성자 직급
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([fmeaId])
  @@index([no])
  @@map("fmea_meeting_minutes")
}

// ============================================================================
// ============ 마스터 데이터 테이블들 (전체 프로젝트 공유) ============
// ============================================================================

// ============ 사용자 정보 마스터 (전체 프로젝트 공유) ============
model User {
  id          String   @id @default(uuid())
  factory     String   // 공장
  department  String   // 부서
  name        String   // 성명
  position    String   // 직급
  phone       String?  // 전화번호
  email       String?  // 이메일
  remark      String?  // 비고
  // ✅ 사용자 인증 필드
  password    String?  // 비밀번호 (해시)
  isActive    Boolean  @default(true) // 활성화 여부
  lastLoginAt DateTime? // 마지막 로그인 일시
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([email])
  @@index([name])
  @@index([department])
  @@index([factory])
  @@index([isActive])
  @@map("users")
}

// ============ 고객사 정보 마스터 (전체 프로젝트 공유) ============
model Customer {
  id          String   @id @default(uuid())
  name        String   // 고객명 (예: 현대자동차)
  code        String?  // 고객 코드 (예: HMC)
  factory     String?  // 공장 (예: 울산공장)
  description String?  // 설명
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([code])
  @@index([name])
  @@map("customers")
}

// ============ 프로젝트 기초정보 마스터 (전체 프로젝트 공유) ============
model BizInfoProject {
  id           String   @id @default(uuid())
  customerName String   // 고객명 (예: 현대자동차)
  customerCode String?  // 고객 코드 (예: HMC)
  factory      String?  // 공장 (예: 울산공장)
  modelYear    String?  // 모델년도 (예: 2025)
  program      String?  // 프로그램 (예: NE1)
  productName  String?  // 품명 (예: 도어패널)
  partNo       String?  // 품번 (예: DP-001)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([customerName])
  @@index([customerCode])
  @@index([productName])
  @@map("bizinfo_projects")
}

// ============================================================================
// ============ 습득교훈 (Lessons Learned) ============
// ============================================================================

model LessonsLearned {
  id            String   @id @default(uuid())
  lldNo         String   @unique // LLD26-001 형식 시리얼 번호
  vehicle       String   // 차종
  target        String   // 대상: '설계' | '부품' | '제조'
  failureMode   String   // 고장형태
  location      String?  // 발생장소
  cause         String   // 발생원인
  category      String   // 구분: '예방관리' | '검출관리'
  improvement   String   // 개선대책
  completedDate String?  // ★ 완료일자 (LLD 완료된 날짜, 수동 입력)
  fmeaId        String?  // ★ 적용결과 (FMEA ID, 자동 입력)
  status        String   @default("R") // 상태: 'G' (완료) | 'Y' (진행중) | 'R' (미완료)
  appliedDate   String?  // ★ 적용일자 (FMEA에 입력된 날짜, 자동)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([lldNo])
  @@index([vehicle])
  @@index([target])
  @@index([status])
  @@index([fmeaId])
  @@map("lessons_learned")
}

// ============================================================================
// ============ Control Plan (관리계획서) ============
// ============================================================================

// CP 헤더 (하나의 FMEA에 여러 CP 가능 - 1:N 관계)
model ControlPlan {
  id            String   @id @default(uuid())
  cpNo          String   @unique  // CP26-M001 형식
  
  // PFMEA 연결 (1:N - 하나의 FMEA에 여러 CP 가능)
  fmeaId        String   // FK: FMEA 프로젝트 ID
  fmeaNo        String?  // pfm26-M001 (표시용)
  fmeaRev       Int      @default(1)  // 연결된 PFMEA Rev
  
  // 기본 정보 (FMEA에서 가져오거나 CP 고유)
  projectName   String?  // 프로젝트명 (FMEA 연동)
  partName      String?  // 품명
  partNo        String?  // 품번
  revNo         String   @default("A")  // Rev No
  revDate       String?  // Rev 일자
  customer      String?  // 고객
  processFrom   String?  // 공정 범위 From
  processTo     String?  // 공정 범위 To
  preparedBy    String?  // 작성자
  approvedBy    String?  // 승인자
  
  // 상태
  status        String   @default("draft")  // draft | approved | obsolete
  
  // 동기화 메타
  syncStatus    String   @default("new")    // new | synced | modified
  lastSyncAt    DateTime?
  changeCount   Int      @default(0)        // 변경 알림 카운트
  
  // 타임스탬프
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // 관계
  items         ControlPlanItem[]
  
  @@index([fmeaId])
  @@index([cpNo])
  @@index([status])
  @@map("control_plans")
}

// CP 행 데이터 (24개 컬럼)
model ControlPlanItem {
  id              String   @id @default(uuid())
  cpId            String   // FK: control_plans.id
  
  // ===== PFMEA 행 연결 (추적성) =====
  pfmeaRowUid     String?  // PFMEA_ROW_UID
  pfmeaProcessId  String?  // PFMEA L2 공정 ID
  pfmeaWorkElemId String?  // PFMEA L3 작업요소 ID
  
  // ===== 공정현황 (PFMEA 연동, Read-only) =====
  processNo       String   // 공정번호
  processName     String   // 공정명
  processLevel    String?  // 공정레벨 (Main/Sub)
  processDesc     String?  // 공정설명
  workElement     String?  // 작업요소
  
  // ===== 공정현황 (CP 전용, Editable) =====
  equipment       String?  // 설비/금형/Jig/Tools
  detectorNo      Boolean  @default(false)  // 검출장치_NO
  detectorEp      Boolean  @default(false)  // 검출장치_EP
  detectorAuto    Boolean  @default(false)  // 검출장치_자동검사
  
  // ===== 관리항목 (PFMEA 연동) =====
  productChar     String?  // 제품특성
  processChar     String?  // 공정특성
  specialChar     String?  // 특별특성 (CC/SC/IC)
  
  // ===== 관리항목 (CP 전용) =====
  specTolerance   String?  // 스펙/공차
  
  // ===== 관리방법 (CP 전용, Editable) =====
  evalMethod      String?  // 평가/측정방법
  sampleSize      String?  // 샘플링 크기
  sampleFreq      String?  // 샘플링 주기
  controlMethod   String?  // 관리방법
  owner1          String?  // 책임1
  owner2          String?  // 책임2
  reactionPlan    String?  // 대응계획
  
  // ===== 리스크 참조 (PFMEA Read-only) =====
  refSeverity     Int?     // 심각도 참조
  refOccurrence   Int?     // 발생도 참조
  refDetection    Int?     // 검출도 참조
  refAp           String?  // AP 참조 (H/M/L)
  
  // ===== 상태 =====
  linkStatus      String   @default("linked")  // linked | changed | unlinked
  changeFlag      Boolean  @default(false)     // 변경 알림 Flag
  
  // 정렬
  sortOrder       Int      @default(0)
  
  // 타임스탬프
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // 관계
  controlPlan     ControlPlan @relation(fields: [cpId], references: [id], onDelete: Cascade)
  
  @@index([cpId])
  @@index([pfmeaRowUid])
  @@index([pfmeaProcessId])
  @@map("control_plan_items")
}

// 동기화 로그
model SyncLog {
  id          String   @id @default(uuid())
  
  sourceType  String   // 'pfmea' | 'cp'
  sourceId    String   // 원본 ID
  targetType  String   // 'pfmea' | 'cp'
  targetId    String   // 대상 ID
  
  action      String   // 'create' | 'update' | 'delete' | 'lock' | 'obsolete'
  status      String   @default("pending")  // pending | synced | failed
  errorMsg    String?  // 실패 시 오류 메시지
  
  fieldChanges String? // 변경된 필드 목록 JSON
  
  syncedAt    DateTime?
  createdAt   DateTime @default(now())
  
  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
  @@index([status])
  @@map("sync_logs")
}
