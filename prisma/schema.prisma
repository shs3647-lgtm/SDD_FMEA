// ============================================================================
// FMEA Smart System - Prisma Schema
// Version: 1.0.0
// Database: PostgreSQL
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ğŸ¢ MASTER TABLES - ê¸°ì´ˆì •ë³´
// ============================================================================

/// íšŒì‚¬ ì •ë³´
model Company {
  id        String   @id @default(cuid())
  name      String   @unique
  plants    Plant[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("companies")
}

/// ê³µì¥ ì •ë³´
model Plant {
  id          String       @id @default(cuid())
  companyId   String
  company     Company      @relation(fields: [companyId], references: [id])
  name        String
  departments Department[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([companyId, name])
  @@map("plants")
}

/// ë¶€ì„œ ì •ë³´
model Department {
  id        String       @id @default(cuid())
  plantId   String
  plant     Plant        @relation(fields: [plantId], references: [id])
  name      String
  members   TeamMember[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([plantId, name])
  @@map("departments")
}

/// íŒ€ì› ì •ë³´
model TeamMember {
  id           String      @id @default(cuid())
  departmentId String
  department   Department  @relation(fields: [departmentId], references: [id])
  name         String
  position     String
  email        String?
  phone        String?
  cftMembers   CFTMember[]
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@map("team_members")
}

/// ì œí’ˆ ì •ë³´
model Product {
  id           String        @id @default(cuid())
  customerName String
  productName  String
  partNumber   String        @unique
  plantName    String?
  productType  ProductType   @default(ASSEMBLY)
  parentId     String?
  parent       Product?      @relation("ProductHierarchy", fields: [parentId], references: [id])
  children     Product[]     @relation("ProductHierarchy")
  fmeaProjects FMEAProject[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("products")
}

enum ProductType {
  ASSEMBLY
  SUBSYSTEM
  COMPONENT
}

// ============================================================================
// ğŸ“‹ PFMEA ê¸°ì´ˆì •ë³´ (Import ë°ì´í„°)
// ============================================================================

/// PFMEA ê¸°ì´ˆì •ë³´ ë§ˆìŠ¤í„°
model PFMEAMasterData {
  id          String   @id @default(cuid())
  itemCode    String   // A1, A2, A3, A4, A5, A6, B1, B2, B3, B4, B5, C1, C2, C3, C4
  processNo   String   // ê³µì •ë²ˆí˜¸ (00: ê³µí†µ, 10, 20, 30...)
  value       String   // ì‹¤ì œ ê°’
  sortOrder   Int      @default(0) // ì •ë ¬ ìˆœì„œ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([itemCode, processNo, value])
  @@index([itemCode])
  @@index([processNo])
  @@map("pfmea_master_data")
}

/// PFMEA ê´€ê³„í˜• ë°ì´í„° (A ê³µì •)
model PFMEARelationA {
  id          String   @id @default(cuid())
  processNo   String   // A1 ê³µì •ë²ˆí˜¸
  processName String   // A2 ê³µì •ëª…
  processFunc String?  // A3 ê³µì •ê¸°ëŠ¥
  productChar String?  // A4 ì œí’ˆíŠ¹ì„±
  failureMode String?  // A5 ê³ ì¥í˜•íƒœ
  detection   String?  // A6 ê²€ì¶œê´€ë¦¬
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([processNo])
  @@map("pfmea_relation_a")
}

/// PFMEA ê´€ê³„í˜• ë°ì´í„° (B ì‘ì—…ìš”ì†Œ)
model PFMEARelationB {
  id             String   @id @default(cuid())
  processNo      String   // A1 ê³µì •ë²ˆí˜¸
  workElement    String   // B1 ì‘ì—…ìš”ì†Œ(ì„¤ë¹„)
  elementFunc    String?  // B2 ì‘ì—…ìš”ì†Œê¸°ëŠ¥
  processChar    String?  // B3 ê³µì •íŠ¹ì„±
  failureCause   String?  // B4 ê³ ì¥ì›ì¸
  prevention     String?  // B5 ì˜ˆë°©ê´€ë¦¬
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([processNo])
  @@map("pfmea_relation_b")
}

/// PFMEA ê´€ê³„í˜• ë°ì´í„° (C ì™„ì œí’ˆ)
model PFMEARelationC {
  id            String   @id @default(cuid())
  category      String   // C1 êµ¬ë¶„ (Your Plant, Ship to Plant, User)
  productFunc   String?  // C2 ì œí’ˆ(ë°˜)ê¸°ëŠ¥
  requirement   String?  // C3 ì œí’ˆ(ë°˜)ìš”êµ¬ì‚¬í•­
  failureEffect String?  // C4 ê³ ì¥ì˜í–¥
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([category])
  @@map("pfmea_relation_c")
}

// ============================================================================
// ğŸ“Š FMEA PROJECT & WORKSHEET
// ============================================================================

/// FMEA í”„ë¡œì íŠ¸
model FMEAProject {
  id           String   @id @default(cuid())
  projectName  String
  fmeaType     FMEAType
  productId    String?
  product      Product? @relation(fields: [productId], references: [id])
  customerName String?
  productName  String?
  partNumber   String?
  startDate    DateTime?
  endDate      DateTime?
  currentStage Int      @default(1)
  status       ProjectStatus @default(DRAFT)

  // ìŠ¹ì¸ê¶Œì
  plannerName  String?
  plannerDate  DateTime?
  checkerName  String?
  checkerDate  DateTime?
  approverName String?
  approverDate DateTime?

  // Relations
  pfmeaWorksheets PFMEAWorksheet[]
  cftMembers      CFTMember[]
  revisions       Revision[]
  improvements    Improvement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("fmea_projects")
}

enum FMEAType {
  PFMEA
  DFMEA
}

enum ProjectStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  RELEASED
  CLOSED
}

/// PFMEA ì›Œí¬ì‹œíŠ¸ (40ì»¬ëŸ¼ - í•µì‹¬ í•„ë“œë§Œ)
model PFMEAWorksheet {
  id        String      @id @default(cuid())
  projectId String
  project   FMEAProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  rowIndex  Int

  // 1ë‹¨ê³„: êµ¬ì¡°ë¶„ì„
  structureL1 String? // ì™„ì œí’ˆëª…
  structureL2 String? // ê³µì •ëª…
  structureL3 String? // ì‘ì—…ìš”ì†Œ

  // 2ë‹¨ê³„: ê¸°ëŠ¥ë¶„ì„
  functionL2 String? // ê³µì •ê¸°ëŠ¥
  functionL3 String? // ì‘ì—…ìš”ì†Œê¸°ëŠ¥

  // 3ë‹¨ê³„: ê³ ì¥ë¶„ì„
  failureEffect String? // FE
  failureMode   String? // FM
  failureCause  String? // FC
  productChar   String? // ì œí’ˆíŠ¹ì„±
  processChar   String? // ê³µì •íŠ¹ì„±
  specialChar   String? // íŠ¹ë³„íŠ¹ì„±

  // 4ë‹¨ê³„: ë¦¬ìŠ¤í¬ë¶„ì„
  preventionCtrl String?  // PC
  detectionCtrl  String?  // DC
  severity       Int?     // S
  occurrence     Int?     // O
  detection      Int?     // D
  apCurrent      APLevel? // AP

  // 5ë‹¨ê³„: ìµœì í™”
  actionType   String?
  actionDesc   String?
  responsible  String?
  targetDate   DateTime?
  actionStatus String?

  // ë©”íƒ€ë°ì´í„°
  mergeParentId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([projectId, rowIndex])
  @@map("pfmea_worksheets")
}

enum APLevel {
  H
  M
  L
}

// ============================================================================
// ğŸ”— RELATION TABLES
// ============================================================================

/// CFT íŒ€ì›
model CFTMember {
  id        String      @id @default(cuid())
  projectId String
  project   FMEAProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  memberId  String
  member    TeamMember  @relation(fields: [memberId], references: [id])
  role      CFTRole
  joinedAt  DateTime    @default(now())

  @@unique([projectId, memberId])
  @@map("cft_members")
}

enum CFTRole {
  LEADER
  MEMBER
  REVIEWER
  OBSERVER
}

/// ê°œì • ì´ë ¥
model Revision {
  id          String      @id @default(cuid())
  projectId   String
  project     FMEAProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  revisionNo  String
  description String
  changedBy   String
  changedAt   DateTime    @default(now())

  @@index([projectId])
  @@map("revisions")
}

/// ê°œì„ ì¡°ì¹˜
model Improvement {
  id             String            @id @default(cuid())
  projectId      String
  project        FMEAProject       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  worksheetRowId String
  apLevel        APLevel
  actionType     String?
  actionDesc     String
  responsible    String
  targetDate     DateTime
  status         ImprovementStatus @default(OPEN)
  completedDate  DateTime?
  evidence       String?

  // SOD ë³€í™”
  severityBefore   Int?
  occurrenceBefore Int?
  detectionBefore  Int?
  severityAfter    Int?
  occurrenceAfter  Int?
  detectionAfter   Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId, status])
  @@map("improvements")
}

enum ImprovementStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  VERIFIED
  CLOSED
}

// ============================================================================
// ğŸ”‘ SOD CRITERIA
// ============================================================================

/// ì‹¬ê°ë„ ê¸°ì¤€
model SeverityCriteria {
  id            String   @id @default(cuid())
  fmeaType      FMEAType
  score         Int
  impact        String
  description   String
  descriptionKr String?
  createdAt     DateTime @default(now())

  @@unique([fmeaType, score, impact])
  @@map("severity_criteria")
}

/// ë°œìƒë„ ê¸°ì¤€
model OccurrenceCriteria {
  id            String   @id @default(cuid())
  fmeaType      FMEAType
  score         Int
  controlType   String
  description   String
  descriptionKr String?
  createdAt     DateTime @default(now())

  @@unique([fmeaType, score])
  @@map("occurrence_criteria")
}

/// ê²€ì¶œë„ ê¸°ì¤€
model DetectionCriteria {
  id            String   @id @default(cuid())
  fmeaType      FMEAType
  score         Int
  maturity      String
  opportunity   String
  description   String
  descriptionKr String?
  createdAt     DateTime @default(now())

  @@unique([fmeaType, score])
  @@map("detection_criteria")
}
